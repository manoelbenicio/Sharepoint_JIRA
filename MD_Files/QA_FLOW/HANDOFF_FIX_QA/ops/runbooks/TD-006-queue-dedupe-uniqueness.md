# TD-006: Queue dedupe + unicidade

## Status: ✅ COMPLETED (2025-12-30T21:26:00-03:00)

## Ownership

- **Executed by**: Human (mbenicios) — *Note: TD-006 is Opus-owned but human drove execution*
- **Peer reviewed by**: Agent Antigravity
- **PowerShell CLI required?**: Yes (PnP PowerShell) → Opus-only

## Goal

Stop queue duplicates and remove existing duplicates safely, using a deterministic **UniqueKey** strategy.

## Strategy (non-negotiable)

- UniqueKey canonical format: `JiraKey|Semana|RecipientEmail(lower)`
- Prevent new duplicates:
  - Enforce uniqueness at SharePoint level (preferred): **Enforce unique values** on `UniqueKey`.
  - Plus Flow-level dedupe checks (already in Flow1 queue-creator).

## Preconditions / Inputs

- Queue list name (current): `StatusReports_Queue_TEST`
- **PnP.PowerShell v3.1.0+** installed
- **Authentication**: Use `-UseWebLogin` (NOT `-Interactive`)
- Confirmation that queue items have:
  - `JiraKey`, `Semana`, `RecipientEmail`, `UniqueKey`
- Decision on which item "wins" when duplicates exist:
  - ✅ **OldestCreated** (keep the first item created)

## Change plan (step-by-step)

1. Dry run scan:
   - Run `ops/scripts/powershell/queue-dedupe.ps1 -Mode Scan`
   - Produce a report grouped by `(UniqueKey)` and `(OfertaId, Semana, RecipientEmail)` with counts.
2. Cleanup (if approved):
   - Run `ops/scripts/powershell/queue-dedupe.ps1 -Mode Cleanup -KeepPolicy OldestCreated -Confirm:$false`
   - It must:
     - keep exactly one item per key (per chosen policy)
     - optionally stamp a note/flag on removed items (or export them before deletion)
3. Enforce uniqueness:
   - Turn on "Enforce unique values" for `UniqueKey` (SharePoint column setting).
4. Canary validation:
   - Set one offer back to pending and run Flow1 queue-creator twice; confirm only one row exists.

## Validation (Level 1 first)

- Duplicates report returns zero for the chosen key strategy.
- Running Flow1 twice does not create additional rows for the same key.

## Rollback (100% automated)

- Restore from exports generated by the script (CSV/JSON) and disable "Enforce unique values" if it blocks writes unexpectedly.

## Evidence to attach (required)

- `Scan` report output file
- `Cleanup` report output file (what was removed/kept)
- Screenshot of SharePoint column setting for `UniqueKey` uniqueness

## Execution log entry (append-only)

Opus must append to `CHECKPOINT.md` → **Execution Log**.

## Peer review checklist

Codex must:
- Validate key format matches canonical contract.
- Validate cleanup policy is deterministic and documented.
- Validate enforcement is enabled and does not break Flow1/Flow2 writes.
- Record findings in `CHECKPOINT.md` → **Peer Review Log**.

---

## Execution Record

| Field | Value |
|-------|-------|
| **Executed at** | 2025-12-30T21:17:00 to 21:26:00-03:00 |
| **Executed by** | Human (mbenicios@minsait.com) |
| **PnP.PowerShell version** | 3.1.0 |
| **Auth method** | `-UseWebLogin` |
| **Outcome** | ✅ OK |
| **KeepPolicy** | OldestCreated |
| **Duplicate groups found** | 61 |
| **Items removed** | 88 |
| **Remaining duplicates** | 0 |

### Reports Generated

| Report | Path |
|--------|------|
| Initial Scan | `tools/reports/queue_dedupe_scan_20251230_211720.csv` |
| Cleanup Plan | `tools/reports/queue_dedupe_cleanup_20251230_212143.csv` |
| Verification Scan | `tools/reports/queue_dedupe_scan_20251230_212621.csv` |

### Script Fixes Applied

During execution, 3 constrained language mode bugs were fixed in `queue-dedupe.ps1`:
1. `[PSCustomObject]@{}` → `New-Object PSObject -Property @{}` (3 usages)
2. `$sorted[0]` → `$sorted | Select-Object -First 1`
3. `$PSCmdlet.ShouldProcess()` → `$WhatIfPreference` check

### Pending Steps

- [ ] Enforce uniqueness on `UniqueKey` column (SharePoint setting)
- [ ] Canary validation: run Flow1 twice, confirm single row
