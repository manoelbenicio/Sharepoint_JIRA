# Runbook: Deploy as a Power Platform Solution (QA → PROD)

This runbook avoids “flow-by-flow drift” and keeps **one professional artifact** for deployment.

## 0) Preconditions
- SharePoint site and lists exist (schemas already mapped in `ZIP/XML/`).
- You have permission to create Solutions and Environment Variables.
- You have the latest flow ZIP exports in `dist_zips/` (generated by `tools/build_deploy_artifacts.sh`).

### Build flow ZIPs (if needed)

```bash
bash tools/build_deploy_artifacts.sh .env
```

## 1) Create the Solution (QA)
1. Go to Power Apps → **Solutions** → **New solution**.
2. Name: `ARQ Status Report (QA)` (suggestion).
3. Publisher: use a dedicated publisher (avoid “Default Publisher” in production).
4. Version: `1.0.0.0`.

## 2) Create Environment Variables + Connection References
1. In the Solution → **New** → **More** → **Environment variable**.
2. Create all variables listed in `SOLUTION/SOLUTION_VARIABLES.md`.
3. In the Solution → **New** → **More** → **Connection reference**:
   - SharePoint
   - Microsoft Teams
   - (Optional) HTTP

## 3) Import flows (recommended workflow)

Power Automate “package import” (`dist_zips/*.zip`) imports flows into **My flows** first.
Then you **add** those flows into the Solution.

1. Power Automate → **My flows** → **Import** → import `dist_zips/flow1.zip ... flow4.zip`.
2. After import, go to Power Apps → **Solutions** → `ARQ Status Report (QA)`.
3. **Add existing** → **Automation** → **Cloud flow** → select the imported flows and add them.
4. Open each flow once and bind:
   - Connection references (SharePoint/Teams)
   - Environment variables (site url, list GUIDs, CardTypeId, Azure Function codes, Teams IDs)

## 4) Listener pattern (mandatory decoupling)

To avoid blocking and sequential “wait for response”:
- Flow1 must **post** cards (no wait).
- Flow2 must be **triggered by card submit** and persist responses.
- Flow3 reads persisted responses, not live flow state.

If the Teams listener trigger is not supported in the new designer:
- Keep `Flow2_Listener_StatusReports` minimal (classic).
- Move all business logic to `Flow2_Process_StatusReports` (new designer) and call it as a child flow.

## 5) Validation (fast proof that responses are captured)
1. Run Flow1 for 1 offer only (filter to a single JiraKey for test).
2. Submit the card.
3. Confirm:
   - A run exists in Flow2 (listener and/or processing flow).
   - An item was created in `StatusReports_Historico`.
   - The offer item in `Ofertas_Pipeline` was updated (Semana/VERSAO flags).

## 6) Export Solution (handoff / PROD)
1. Power Apps → Solutions → select the solution → **Export**.
2. Export as **unmanaged** for QA handoff; **managed** for PROD deployment.
3. Store exported zip under `dist_solution_exports/` (do not commit secrets).

## 7) Cleanup policy (after solution validated)
- Disable old `*_v5/_v6/_v7` flows.
- Keep at least one exported backup zip before deleting.
